import { z } from 'zod';

/**
 * Environment variable validation and type-safe access
 *
 * This module validates all required environment variables on startup
 * and provides type-safe access throughout the application.
 */

// Define the schema for environment variables
const envSchema = z.object({
  // Node environment
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),

  // Application configuration
  NEXT_PUBLIC_APP_NAME: z.string().min(1, 'App name is required'),
  NEXT_PUBLIC_APP_URL: z.string().url('App URL must be a valid URL'),

{{#if (eq backend "firebase")}}
{{#if (eq firebasePattern "client-side")}}
  // Firebase Client SDK
  NEXT_PUBLIC_FIREBASE_API_KEY: z.string().min(1, 'Firebase API key is required'),
  NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: z.string().min(1, 'Firebase auth domain is required'),
  NEXT_PUBLIC_FIREBASE_PROJECT_ID: z.string().min(1, 'Firebase project ID is required'),
  NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: z.string().min(1, 'Firebase storage bucket is required'),
  NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: z
    .string()
    .min(1, 'Firebase messaging sender ID is required'),
  NEXT_PUBLIC_FIREBASE_APP_ID: z.string().min(1, 'Firebase app ID is required'),
{{else}}
  // Firebase Admin SDK (server-side)
  FIREBASE_PROJECT_ID: z.string().min(1, 'Firebase project ID is required'),
  FIREBASE_CLIENT_EMAIL: z
    .string()
    .email('Firebase client email must be a valid email')
    .min(1, 'Firebase client email is required'),
  FIREBASE_PRIVATE_KEY: z
    .string()
    .min(1, 'Firebase private key is required')
    .refine((key) => key.includes('BEGIN PRIVATE KEY'), {
      message: 'Firebase private key must be a valid PEM-encoded private key',
    }),
{{/if}}
{{/if}}
});

// Validate environment variables
function validateEnv() {
  try {
    return envSchema.parse(process.env);
  } catch (error) {
    if (error instanceof z.ZodError) {
      const missingVars = error.errors.map((err) => `  - ${err.path.join('.')}: ${err.message}`);

      console.error('‚ùå Invalid environment variables:\n');
      console.error(missingVars.join('\n'));
      console.error('\nüí° Check your .env.local file and compare with .env.example\n');

      throw new Error('Invalid environment variables. See error messages above.');
    }
    throw error;
  }
}

// Export validated and type-safe environment variables
export const env = validateEnv();

// Export types for use in other files
export type Env = z.infer<typeof envSchema>;
