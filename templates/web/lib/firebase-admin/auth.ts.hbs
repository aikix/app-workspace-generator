/**
 * Firebase Admin Authentication Helpers
 *
 * Server-side authentication utilities for:
 * - Verifying Firebase ID tokens
 * - Getting user information
 * - Managing user sessions
 * - Custom token creation
 */

import { adminAuth } from './config';
import type { DecodedIdToken } from 'firebase-admin/auth';
import { cookies } from 'next/headers';

/**
 * Verify a Firebase ID token from the client
 * Use this to authenticate requests in:
 * - Server Components
 * - Server Actions
 * - API Routes
 *
 * @param token - Firebase ID token from client (from getIdToken())
 * @returns Decoded token with user information
 * @throws Error if token is invalid or expired
 */
export async function verifyIdToken(token: string): Promise<DecodedIdToken> {
  try {
    return await adminAuth.verifyIdToken(token);
  } catch (error) {
    throw new Error(`Invalid or expired token: ${error instanceof Error ? error.message : 'Unknown error'}`);
  }
}

/**
 * Get the current user from the session cookie
 * Use this in Server Components and Server Actions
 *
 * @returns Decoded token if valid session exists, null otherwise
 */
export async function getCurrentUser(): Promise<DecodedIdToken | null> {
  const cookieStore = await cookies();
  const sessionCookie = cookieStore.get('session')?.value;

  if (!sessionCookie) {
    return null;
  }

  try {
    return await adminAuth.verifySessionCookie(sessionCookie, true);
  } catch (error) {
    // Session invalid or expired
    return null;
  }
}

/**
 * Require authentication - throws error if user not authenticated
 * Use this to protect Server Components and Server Actions
 *
 * @returns Decoded token with user information
 * @throws Error if user is not authenticated
 */
export async function requireAuth(): Promise<DecodedIdToken> {
  const user = await getCurrentUser();

  if (!user) {
    throw new Error('Authentication required. Please log in.');
  }

  return user;
}

/**
 * Create a session cookie from an ID token
 * Call this from your login API route after client authenticates
 *
 * @param idToken - Firebase ID token from client
 * @param expiresIn - Session duration in milliseconds (default: 7 days)
 * @returns Session cookie string
 */
export async function createSessionCookie(
  idToken: string,
  expiresIn: number = 7 * 24 * 60 * 60 * 1000 // 7 days
): Promise<string> {
  try {
    const sessionCookie = await adminAuth.createSessionCookie(idToken, { expiresIn });
    return sessionCookie;
  } catch (error) {
    throw new Error(`Failed to create session cookie: ${error instanceof Error ? error.message : 'Unknown error'}`);
  }
}

/**
 * Revoke all refresh tokens for a user (force sign out)
 * Use this for logout or security purposes
 *
 * @param uid - User ID
 */
export async function revokeRefreshTokens(uid: string): Promise<void> {
  try {
    await adminAuth.revokeRefreshTokens(uid);
  } catch (error) {
    throw new Error(`Failed to revoke tokens: ${error instanceof Error ? error.message : 'Unknown error'}`);
  }
}

/**
 * Get user by UID
 * Use this to fetch user information server-side
 *
 * @param uid - User ID
 * @returns User record
 */
export async function getUserByUid(uid: string) {
  try {
    return await adminAuth.getUser(uid);
  } catch (error) {
    throw new Error(`User not found: ${error instanceof Error ? error.message : 'Unknown error'}`);
  }
}

/**
 * Get user by email
 *
 * @param email - User email
 * @returns User record
 */
export async function getUserByEmail(email: string) {
  try {
    return await adminAuth.getUserByEmail(email);
  } catch (error) {
    throw new Error(`User not found: ${error instanceof Error ? error.message : 'Unknown error'}`);
  }
}

/**
 * Set custom claims for a user
 * Use this for role-based access control
 *
 * @param uid - User ID
 * @param claims - Custom claims object (e.g., { admin: true, role: 'editor' })
 */
export async function setCustomClaims(uid: string, claims: Record<string, unknown>): Promise<void> {
  try {
    await adminAuth.setCustomUserClaims(uid, claims);
  } catch (error) {
    throw new Error(`Failed to set custom claims: ${error instanceof Error ? error.message : 'Unknown error'}`);
  }
}
