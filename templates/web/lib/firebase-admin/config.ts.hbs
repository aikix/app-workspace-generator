/**
 * Firebase Admin SDK Configuration
 *
 * This file initializes the Firebase Admin SDK for server-side use.
 * Use this for:
 * - Server Components (RSC)
 * - Server Actions
 * - API Routes
 * - Secure data access (credentials never exposed to client)
 *
 * IMPORTANT: Admin SDK uses service account credentials - NEVER expose these to the client!
 */

import { initializeApp, getApps, cert, type ServiceAccount } from 'firebase-admin/app';
import { getAuth } from 'firebase-admin/auth';
import { getFirestore } from 'firebase-admin/firestore';

// Service account credentials from environment variables
// In production, store these securely (never in client code!)
const serviceAccount: ServiceAccount = {
  projectId: process.env.FIREBASE_PROJECT_ID,
  clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
  // Handle newlines in private key (some deployment platforms escape them)
  privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
};

// Validate required credentials
if (!serviceAccount.projectId || !serviceAccount.clientEmail || !serviceAccount.privateKey) {
  throw new Error(
    'Missing Firebase Admin SDK credentials. Required: FIREBASE_PROJECT_ID, FIREBASE_CLIENT_EMAIL, FIREBASE_PRIVATE_KEY'
  );
}

/**
 * Initialize Firebase Admin SDK (singleton pattern)
 * Only initializes once even with Hot Module Replacement
 */
export const adminApp =
  getApps().length === 0
    ? initializeApp({
        credential: cert(serviceAccount),
      })
    : getApps()[0]!;

/**
 * Firebase Admin Auth instance
 * Use for:
 * - Verifying ID tokens from client
 * - Creating custom tokens
 * - Managing users server-side
 * - Setting custom claims
 */
export const adminAuth = getAuth(adminApp);

/**
 * Firestore Admin instance
 * Use for:
 * - Server-side data fetching (no security rules)
 * - Server Actions (mutations)
 * - Administrative operations
 * - Full database access with admin privileges
 */
export const adminDb = getFirestore(adminApp);

// Configure Firestore settings
adminDb.settings({
  ignoreUndefinedProperties: true,
});

export default adminApp;
