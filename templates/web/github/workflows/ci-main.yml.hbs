name: CI - Main

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'CHANGELOG.md'
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    branches:
      - main

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: $\{{ matrix.node-version }}
          cache: '{{packageManager}}'

      - name: Install dependencies
        run: {{#if (eq packageManager "npm")}}npm ci{{else if (eq packageManager "yarn")}}yarn install --frozen-lockfile{{else if (eq packageManager "pnpm")}}pnpm install --frozen-lockfile{{else}}bun install --frozen-lockfile{{/if}}

{{#if (and (eq backend "firebase") hasFunctions)}}
      - name: Install Firebase Functions dependencies
        run: |
          cd functions
          {{#if (eq packageManager "npm")}}npm ci{{else if (eq packageManager "yarn")}}yarn install --frozen-lockfile{{else if (eq packageManager "pnpm")}}pnpm install --frozen-lockfile{{else}}bun install --frozen-lockfile{{/if}}
{{/if}}

{{#if typescript}}
      - name: Type check
        run: {{#if (eq packageManager "npm")}}npm run{{else if (eq packageManager "yarn")}}yarn{{else if (eq packageManager "pnpm")}}pnpm{{else}}bun run{{/if}} type-check
{{/if}}

{{#if linting}}
      - name: Lint
        run: {{#if (eq packageManager "npm")}}npm run{{else if (eq packageManager "yarn")}}yarn{{else if (eq packageManager "pnpm")}}pnpm{{else}}bun run{{/if}} lint
{{/if}}

{{#if formatting}}
      - name: Format check
        run: {{#if (eq packageManager "npm")}}npm run{{else if (eq packageManager "yarn")}}yarn{{else if (eq packageManager "pnpm")}}pnpm{{else}}bun run{{/if}} format:check
{{/if}}

      - name: Build
        run: {{#if (eq packageManager "npm")}}npm run{{else if (eq packageManager "yarn")}}yarn{{else if (eq packageManager "pnpm")}}pnpm{{else}}bun run{{/if}} build
        env:
          NODE_ENV: production

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: quality-checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: '{{packageManager}}'

      - name: Install dependencies
        run: {{#if (eq packageManager "npm")}}npm ci{{else if (eq packageManager "yarn")}}yarn install --frozen-lockfile{{else if (eq packageManager "pnpm")}}pnpm install --frozen-lockfile{{else}}bun install --frozen-lockfile{{/if}}

      - name: Run security audit
        run: {{#if (eq packageManager "npm")}}npm audit --audit-level=high{{else if (eq packageManager "yarn")}}yarn audit --level high{{else if (eq packageManager "pnpm")}}pnpm audit --audit-level high{{else}}bun audit{{/if}}
        continue-on-error: true

{{#if (eq testing "playwright")}}
  e2e-tests:
    name: E2E Tests (Optional)
    runs-on: ubuntu-latest
    needs: quality-checks
    # Uncomment to enable E2E tests on main branch CI
    # if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: '{{packageManager}}'

      - name: Install dependencies
        run: {{#if (eq packageManager "npm")}}npm ci{{else if (eq packageManager "yarn")}}yarn install --frozen-lockfile{{else if (eq packageManager "pnpm")}}pnpm install --frozen-lockfile{{else}}bun install --frozen-lockfile{{/if}}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: {{#if (eq packageManager "npm")}}npm run{{else if (eq packageManager "yarn")}}yarn{{else if (eq packageManager "pnpm")}}pnpm{{else}}bun run{{/if}} e2e
        env:
          CI: true

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
{{/if}}
